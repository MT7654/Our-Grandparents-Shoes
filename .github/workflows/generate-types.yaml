name: 'generate-types'
on:
  pull_request:

jobs:
  build: 
    runs-on: ubuntu-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: Setup Supabase CLI
          uses: supabase/setup-cli@v1
          with:
            version: latest
        - name: Initialize Supabase
          run: supabase init
        - name: Start Supabase database
          run: supabase db start
        - name: Wait for database to be ready
          run: |
            echo "Waiting for database to be ready..."
            sleep 5
            timeout=60
            counter=0
            until supabase status --local > /dev/null 2>&1; do
              if [ $counter -ge $timeout ]; then
                echo "Database failed to start within $timeout seconds"
                exit 1
              fi
              echo "Still waiting for database..."
              sleep 2
              counter=$((counter + 2))
            done
            echo "Database is ready"
        - name: Generate types
          run: |
            supabase gen types typescript --local > supabase/types.generated.ts
            if [ ! -f supabase/types.generated.ts ]; then
              echo "::error::Failed to generate types file"
              exit 1
            fi
        - name: Verify generated types match Postgres schema
          run: |
            if [ ! -f supabase/types.ts ]; then
              echo "::error::types.ts file not found in repository"
              exit 1
            fi
            if ! cmp -s supabase/types.ts supabase/types.generated.ts; then
              echo "::error::Generated types do not match the committed types file."
              echo "Differences:"
              /usr/bin/diff --no-index -u supabase/types.ts supabase/types.generated.ts || true
              echo ""
              echo "Please run 'supabase gen types typescript --local > supabase/types.ts' and commit the changes."
              exit 1
            fi
            echo "âœ“ Generated types match the committed types file"