{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/iamhe/Downloads/senior-conversation-trainer/app/api/evaluate/route.ts"],"sourcesContent":["import Groq from \"groq-sdk\"\r\nimport { NextRequest, NextResponse } from \"next/server\"\r\n\r\nconst apiKey = process.env.NEXT_PUBLIC_GROQ_API_KEY\r\n\r\nif (!apiKey) {\r\n  console.error(\"NEXT_PUBLIC_GROQ_API_KEY is not set\")\r\n}\r\n\r\nconst groq = apiKey ? new Groq({ apiKey }) : null\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    if (!groq || !apiKey) {\r\n      return NextResponse.json(\r\n        { error: \"API key not configured. Please set NEXT_PUBLIC_GROQ_API_KEY environment variable.\" },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    const body = await request.json()\r\n    const { userMessage, personaResponse, objective } = body\r\n\r\n    if (!userMessage || !personaResponse) {\r\n      return NextResponse.json({ error: \"userMessage and personaResponse are required\" }, { status: 400 })\r\n    }\r\n\r\n    const evaluationPrompt = `You are an expert conversation coach evaluating a conversation between a user and a senior persona. Analyze the user's message and the persona's response.\r\n\r\nUser's message: \"${userMessage}\"\r\nPersona's response: \"${personaResponse}\"\r\n${objective ? `Training objective: \"${objective}\"` : \"\"}\r\n\r\nEvaluate the conversation and provide:\r\n1. Sentiment: \"positive\", \"neutral\", or \"negative\" - based on how the user's message would make the senior feel\r\n2. Expression: \"happy\", \"neutral\", \"sad\", or \"angry\" - the emotional expression the senior would show\r\n3. Rapport change: a number between -10 and +15 indicating how much the rapport improved or worsened\r\n4. Suggestion: a helpful coaching tip (1-2 sentences) for the user to improve their conversation skills\r\n\r\nRespond ONLY with a valid JSON object in this exact format:\r\n{\r\n  \"sentiment\": \"positive|neutral|negative\",\r\n  \"expression\": \"happy|neutral|sad|angry\",\r\n  \"rapportChange\": <number>,\r\n  \"suggestion\": \"<coaching tip>\"\r\n}`\r\n\r\n    // Try multiple models in case one is unavailable\r\n    const modelNames = [\r\n      \"llama-3.1-8b-instant\",      // Fast, smaller model\r\n      \"mixtral-8x7b-32768\",        // Mixtral model\r\n      \"llama-3.3-70b-versatile\",   // Newer 70B model (if available)\r\n    ]\r\n\r\n    let completion\r\n    let lastError: Error | null = null\r\n\r\n    for (const modelName of modelNames) {\r\n      try {\r\n        completion = await groq.chat.completions.create({\r\n          model: modelName,\r\n          messages: [\r\n            {\r\n              role: \"system\",\r\n              content: \"You are an expert conversation coach. Always respond with valid JSON only, no additional text.\",\r\n            },\r\n            { role: \"user\", content: evaluationPrompt },\r\n          ],\r\n          temperature: 0.3, // Lower temperature for more consistent evaluation\r\n          max_tokens: 200,\r\n          response_format: { type: \"json_object\" }, // Force JSON response\r\n        })\r\n        break // Success, exit loop\r\n      } catch (err) {\r\n        lastError = err instanceof Error ? err : new Error(String(err))\r\n        console.log(`Evaluation model ${modelName} failed, trying next...`)\r\n        continue\r\n      }\r\n    }\r\n\r\n    if (!completion) {\r\n      throw new Error(`All evaluation models failed. Last error: ${lastError?.message || \"Unknown error\"}`)\r\n    }\r\n\r\n    const text = completion.choices[0]?.message?.content || \"{}\"\r\n\r\n    // Parse JSON response\r\n    let evaluation\r\n    try {\r\n      evaluation = JSON.parse(text)\r\n    } catch (parseError) {\r\n      // Try to extract JSON if wrapped in text\r\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/)\r\n      if (jsonMatch) {\r\n        evaluation = JSON.parse(jsonMatch[0])\r\n      } else {\r\n        throw new Error(\"Could not parse JSON from AI response\")\r\n      }\r\n    }\r\n\r\n    // Validate and normalize the response\r\n    const validSentiments = [\"positive\", \"neutral\", \"negative\"]\r\n    const validExpressions = [\"happy\", \"neutral\", \"sad\", \"angry\"]\r\n\r\n    if (!validSentiments.includes(evaluation.sentiment)) {\r\n      evaluation.sentiment = \"neutral\"\r\n    }\r\n    if (!validExpressions.includes(evaluation.expression)) {\r\n      evaluation.expression = \"neutral\"\r\n    }\r\n    if (typeof evaluation.rapportChange !== \"number\") {\r\n      evaluation.rapportChange = 0\r\n    } else {\r\n      evaluation.rapportChange = Math.max(-10, Math.min(15, Math.round(evaluation.rapportChange)))\r\n    }\r\n    if (!evaluation.suggestion || typeof evaluation.suggestion !== \"string\") {\r\n      evaluation.suggestion = \"Continue showing genuine interest and empathy in the conversation.\"\r\n    }\r\n\r\n    return NextResponse.json(evaluation)\r\n  } catch (error) {\r\n    console.error(\"Error evaluating conversation:\", error)\r\n    // Return a default evaluation on error\r\n    return NextResponse.json(\r\n      {\r\n        sentiment: \"neutral\",\r\n        expression: \"neutral\",\r\n        rapportChange: 0,\r\n        suggestion: \"Continue showing genuine interest and empathy in the conversation.\",\r\n      },\r\n      { status: 200 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}