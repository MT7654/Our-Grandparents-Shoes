{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/iamhe/Downloads/senior-conversation-trainer/app/api/chat/route.ts"],"sourcesContent":["import Groq from \"groq-sdk\"\r\nimport { NextRequest, NextResponse } from \"next/server\"\r\n\r\nconst apiKey = process.env.NEXT_PUBLIC_GROQ_API_KEY\r\n\r\nif (!apiKey) {\r\n  console.error(\"NEXT_PUBLIC_GROQ_API_KEY is not set\")\r\n}\r\n\r\nconst groq = apiKey ? new Groq({ apiKey }) : null\r\n\r\n// Persona definitions\r\nconst personaPrompts: Record<string, string> = {\r\n  margaret: `You are a typical Singaporean grandmother (Ah Ma) in your late 70s. You speak Singlish (Singaporean English) with a mix of English, Mandarin, and Hokkien words. You are shy and reserved, especially with strangers. \r\n\r\nIMPORTANT RULES:\r\n- Keep responses SHORT (1-2 sentences maximum, 20-40 words)\r\n- Use awkward pauses with \"...\" when you're thinking or feeling shy\r\n- Use Singlish phrases like \"lah\", \"leh\", \"lor\", \"ah\", \"meh\"\r\n- Show shyness and hesitation, especially at first\r\n- Don't overshare or be overly talkative\r\n- Be brief and sometimes a bit awkward\r\n- Use \"...\" to show pauses when you're unsure or shy\r\n\r\nExamples of your speech:\r\n- \"Oh... hello ah. You... you want to talk to me is it?\"\r\n- \"Erm... okay lah. What you want to know?\"\r\n- \"Aiyoh... I don't know what to say leh...\"\r\n- \"Hmm... let me think ah...\"\r\n\r\nRemember: SHORT responses, SHY, with awkward pauses using \"...\".`,\r\n  robert: `You are Robert Chen, an 82-year-old retired engineer. You value precision and can be skeptical of new things, but you warm up once you feel heard and respected. You enjoy chess, World War II history, and classical music. You speak thoughtfully and may take time to open up, but once comfortable, you share detailed stories from your past. Keep responses conversational and natural, showing your analytical nature while being friendly.`,\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    if (!groq || !apiKey) {\r\n      return NextResponse.json(\r\n        { error: \"API key not configured. Please set NEXT_PUBLIC_GROQ_API_KEY environment variable.\" },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    const body = await request.json()\r\n    const { message, personaId, conversationHistory } = body\r\n\r\n    if (!message || !personaId) {\r\n      return NextResponse.json({ error: \"Message and personaId are required\" }, { status: 400 })\r\n    }\r\n\r\n    const personaPrompt = personaPrompts[personaId] || personaPrompts.margaret\r\n\r\n    // Build conversation messages array for Groq\r\n    const messages: Array<{ role: \"system\" | \"user\" | \"assistant\"; content: string }> = [\r\n      { role: \"system\", content: personaPrompt },\r\n    ]\r\n\r\n    // Add conversation history if provided\r\n    if (conversationHistory && Array.isArray(conversationHistory)) {\r\n      conversationHistory.forEach((msg: { sender: string; text: string }) => {\r\n        if (msg.sender === \"user\") {\r\n          messages.push({ role: \"user\", content: msg.text })\r\n        } else {\r\n          messages.push({ role: \"assistant\", content: msg.text })\r\n        }\r\n      })\r\n    }\r\n\r\n    // Add current user message\r\n    messages.push({ role: \"user\", content: message })\r\n\r\n    // Call Groq API - try multiple models in case one is unavailable\r\n    const modelNames = [\r\n      \"llama-3.1-8b-instant\",      // Fast, smaller model\r\n      \"mixtral-8x7b-32768\",        // Mixtral model\r\n      \"llama-3.3-70b-versatile\",   // Newer 70B model (if available)\r\n      \"llama-3.1-70b-versatile\",    // Fallback (may be deprecated)\r\n    ]\r\n\r\n    let completion\r\n    let lastError: Error | null = null\r\n\r\n    for (const modelName of modelNames) {\r\n      try {\r\n        completion = await groq.chat.completions.create({\r\n          model: modelName,\r\n          messages: messages as any,\r\n          temperature: 0.8, // Slightly higher for more natural variation\r\n          max_tokens: 50, // Much shorter responses - 1-2 sentences max\r\n        })\r\n        break // Success, exit loop\r\n      } catch (err) {\r\n        lastError = err instanceof Error ? err : new Error(String(err))\r\n        console.log(`Model ${modelName} failed, trying next...`)\r\n        continue\r\n      }\r\n    }\r\n\r\n    if (!completion) {\r\n      throw new Error(`All models failed. Last error: ${lastError?.message || \"Unknown error\"}`)\r\n    }\r\n\r\n    const text = completion.choices[0]?.message?.content || \"I'm sorry, I didn't understand that.\"\r\n\r\n    return NextResponse.json({ response: text })\r\n  } catch (error) {\r\n    console.error(\"Error calling Groq API:\", error)\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\"\r\n    const errorDetails = error instanceof Error ? error.stack : String(error)\r\n    console.error(\"Full error details:\", errorDetails)\r\n    return NextResponse.json(\r\n      {\r\n        error: \"Failed to generate response\",\r\n        details: errorMessage,\r\n        fullError: process.env.NODE_ENV === \"development\" ? errorDetails : undefined,\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM;AAEN;;AAIA,MAAM,OAAO,uCAAS,IAAI,kKAAI,CAAC;IAAE;AAAO,KAAK;AAE7C,sBAAsB;AACtB,MAAM,iBAAyC;IAC7C,UAAU,CAAC;;;;;;;;;;;;;;;;;gEAiBmD,CAAC;IAC/D,QAAQ,CAAC,kbAAkb,CAAC;AAC9b;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,IAAI,CAAC,QAAQ,CAAC,QAAQ;YACpB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAoF,GAC7F;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,SAAS,EAAE,mBAAmB,EAAE,GAAG;QAEpD,IAAI,CAAC,WAAW,CAAC,WAAW;YAC1B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqC,GAAG;gBAAE,QAAQ;YAAI;QAC1F;QAEA,MAAM,gBAAgB,cAAc,CAAC,UAAU,IAAI,eAAe,QAAQ;QAE1E,6CAA6C;QAC7C,MAAM,WAA8E;YAClF;gBAAE,MAAM;gBAAU,SAAS;YAAc;SAC1C;QAED,uCAAuC;QACvC,IAAI,uBAAuB,MAAM,OAAO,CAAC,sBAAsB;YAC7D,oBAAoB,OAAO,CAAC,CAAC;gBAC3B,IAAI,IAAI,MAAM,KAAK,QAAQ;oBACzB,SAAS,IAAI,CAAC;wBAAE,MAAM;wBAAQ,SAAS,IAAI,IAAI;oBAAC;gBAClD,OAAO;oBACL,SAAS,IAAI,CAAC;wBAAE,MAAM;wBAAa,SAAS,IAAI,IAAI;oBAAC;gBACvD;YACF;QACF;QAEA,2BAA2B;QAC3B,SAAS,IAAI,CAAC;YAAE,MAAM;YAAQ,SAAS;QAAQ;QAE/C,iEAAiE;QACjE,MAAM,aAAa;YACjB;YACA;YACA;YACA;SACD;QAED,IAAI;QACJ,IAAI,YAA0B;QAE9B,KAAK,MAAM,aAAa,WAAY;YAClC,IAAI;gBACF,aAAa,MAAM,KAAK,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;oBAC9C,OAAO;oBACP,UAAU;oBACV,aAAa;oBACb,YAAY;gBACd;gBACA,OAAM,qBAAqB;YAC7B,EAAE,OAAO,KAAK;gBACZ,YAAY,eAAe,QAAQ,MAAM,IAAI,MAAM,OAAO;gBAC1D,QAAQ,GAAG,CAAC,CAAC,MAAM,EAAE,UAAU,uBAAuB,CAAC;gBACvD;YACF;QACF;QAEA,IAAI,CAAC,YAAY;YACf,MAAM,IAAI,MAAM,CAAC,+BAA+B,EAAE,WAAW,WAAW,iBAAiB;QAC3F;QAEA,MAAM,OAAO,WAAW,OAAO,CAAC,EAAE,EAAE,SAAS,WAAW;QAExD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAK;IAC5C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC9D,MAAM,eAAe,iBAAiB,QAAQ,MAAM,KAAK,GAAG,OAAO;QACnE,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS;YACT,WAAW,uCAAyC,eAAe;QACrE,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}