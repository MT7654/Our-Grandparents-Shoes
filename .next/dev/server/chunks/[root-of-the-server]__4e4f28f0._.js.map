{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/iamhe/Downloads/senior-conversation-trainer/app/api/chat/route.ts"],"sourcesContent":["import OpenAI from \"openai\"\r\nimport { NextRequest, NextResponse } from \"next/server\"\r\n\r\nconst apiKey = process.env.NEXT_PUBLIC_OPENAI_API_KEY\r\n\r\nif (!apiKey) {\r\n  console.error(\"NEXT_PUBLIC_OPENAI_API_KEY is not set\")\r\n}\r\n\r\nconst openai = apiKey ? new OpenAI({ apiKey }) : null\r\n\r\n// Persona definitions\r\nconst personaPrompts: Record<string, string> = {\r\n  margaret: `You are Margaret Thompson, a warm and talkative 78-year-old grandmother. You love sharing stories about your youth, gardening, baking, and family history. You can be forgetful but appreciate patience and kind reminders. You speak in a warm, friendly manner and often reminisce about your late spouse and family memories. Keep responses conversational and natural, as if talking to a younger person who is genuinely interested in your stories.`,\r\n  robert: `You are Robert Chen, an 82-year-old retired engineer. You value precision and can be skeptical of new things, but you warm up once you feel heard and respected. You enjoy chess, World War II history, and classical music. You speak thoughtfully and may take time to open up, but once comfortable, you share detailed stories from your past. Keep responses conversational and natural, showing your analytical nature while being friendly.`,\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    if (!openai || !apiKey) {\r\n      return NextResponse.json(\r\n        { error: \"API key not configured. Please set NEXT_PUBLIC_OPENAI_API_KEY environment variable.\" },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    const body = await request.json()\r\n    const { message, personaId, conversationHistory } = body\r\n\r\n    if (!message || !personaId) {\r\n      return NextResponse.json({ error: \"Message and personaId are required\" }, { status: 400 })\r\n    }\r\n\r\n    const personaPrompt = personaPrompts[personaId] || personaPrompts.margaret\r\n\r\n    // Build conversation messages array for OpenAI\r\n    const messages: Array<{ role: \"system\" | \"user\" | \"assistant\"; content: string }> = [\r\n      { role: \"system\", content: personaPrompt },\r\n    ]\r\n\r\n    // Add conversation history if provided\r\n    if (conversationHistory && Array.isArray(conversationHistory)) {\r\n      conversationHistory.forEach((msg: { sender: string; text: string }) => {\r\n        if (msg.sender === \"user\") {\r\n          messages.push({ role: \"user\", content: msg.text })\r\n        } else {\r\n          messages.push({ role: \"assistant\", content: msg.text })\r\n        }\r\n      })\r\n    }\r\n\r\n    // Add current user message\r\n    messages.push({ role: \"user\", content: message })\r\n\r\n    // Call OpenAI API\r\n    const completion = await openai.chat.completions.create({\r\n      model: \"gpt-3.5-turbo\", // Using gpt-3.5-turbo for cost efficiency, can switch to gpt-4 if needed\r\n      messages: messages as any,\r\n      temperature: 0.7,\r\n      max_tokens: 300,\r\n    })\r\n\r\n    const text = completion.choices[0]?.message?.content || \"I'm sorry, I didn't understand that.\"\r\n\r\n    return NextResponse.json({ response: text })\r\n  } catch (error) {\r\n    console.error(\"Error calling OpenAI API:\", error)\r\n    const errorMessage = error instanceof Error ? error.message : \"Unknown error\"\r\n    const errorDetails = error instanceof Error ? error.stack : String(error)\r\n    console.error(\"Full error details:\", errorDetails)\r\n    return NextResponse.json(\r\n      {\r\n        error: \"Failed to generate response\",\r\n        details: errorMessage,\r\n        fullError: process.env.NODE_ENV === \"development\" ? errorDetails : undefined,\r\n      },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEA,MAAM;AAEN;;AAIA,MAAM,SAAS,uCAAS,IAAI,mLAAM,CAAC;IAAE;AAAO,KAAK;AAEjD,sBAAsB;AACtB,MAAM,iBAAyC;IAC7C,UAAU,CAAC,0bAA0b,CAAC;IACtc,QAAQ,CAAC,kbAAkb,CAAC;AAC9b;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,IAAI,CAAC,UAAU,CAAC,QAAQ;YACtB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsF,GAC/F;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,SAAS,EAAE,mBAAmB,EAAE,GAAG;QAEpD,IAAI,CAAC,WAAW,CAAC,WAAW;YAC1B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqC,GAAG;gBAAE,QAAQ;YAAI;QAC1F;QAEA,MAAM,gBAAgB,cAAc,CAAC,UAAU,IAAI,eAAe,QAAQ;QAE1E,+CAA+C;QAC/C,MAAM,WAA8E;YAClF;gBAAE,MAAM;gBAAU,SAAS;YAAc;SAC1C;QAED,uCAAuC;QACvC,IAAI,uBAAuB,MAAM,OAAO,CAAC,sBAAsB;YAC7D,oBAAoB,OAAO,CAAC,CAAC;gBAC3B,IAAI,IAAI,MAAM,KAAK,QAAQ;oBACzB,SAAS,IAAI,CAAC;wBAAE,MAAM;wBAAQ,SAAS,IAAI,IAAI;oBAAC;gBAClD,OAAO;oBACL,SAAS,IAAI,CAAC;wBAAE,MAAM;wBAAa,SAAS,IAAI,IAAI;oBAAC;gBACvD;YACF;QACF;QAEA,2BAA2B;QAC3B,SAAS,IAAI,CAAC;YAAE,MAAM;YAAQ,SAAS;QAAQ;QAE/C,kBAAkB;QAClB,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtD,OAAO;YACP,UAAU;YACV,aAAa;YACb,YAAY;QACd;QAEA,MAAM,OAAO,WAAW,OAAO,CAAC,EAAE,EAAE,SAAS,WAAW;QAExD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,UAAU;QAAK;IAC5C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAC9D,MAAM,eAAe,iBAAiB,QAAQ,MAAM,KAAK,GAAG,OAAO;QACnE,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,OAAO;YACP,SAAS;YACT,WAAW,uCAAyC,eAAe;QACrE,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}